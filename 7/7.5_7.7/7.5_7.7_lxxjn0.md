# Real-MySQL 7.5 - 7.7

## 7.5 INSERT

MySQL에서 `insert`를 하는 방법은 다양하게 있다. 여러 방법들에서 상황에 적절한 `insert` 쿼리를 익혀두면 성능 개선 효과를 기대할 수 있을 것이다.

### 7.5.1 INSERT와 AUTO_INCREMENT

MySQL에는 순차적으로 증가하는 숫자 값을 가져오는 `auto_increment`라는 기능을 제공한다. 이는 테이블의 칼럼에 부여되는 옵션이기 때문에 하나의 테이블에서만 순차적으로 값이 증가한다.

만약 여러 테이블에 동시에 사용할 수 있는 `auto_increment` 기능이 필요하다면 별도의 테이블을 생성하여 사용할 수 있다(16.4 MySQL 시퀀스 구현 참고)

#### AUTO_INCREMENT 제약 및 특성

```sql
create table tb_autoincrement (
    member_id int not null auto_increment,
    member_name varchar(30) not null,
    primary key (member_id)
) engine=INNODB;
```

테이블의 칼럼에 `auto_increment` 속성을 부여하면 된다.

```sql
insert into tb_autoincrement (member_name) values ('lxxjn0');
insert into tb_autoincrement (member_id, member_name) values (5, 'lxxjn0');
```

- 첫 번째 `insert` 쿼리처럼 `auto_increment` 속성으로 정의된 칼럼은 별도로 값을 할당하지 않고 사용한다.

  - `member_id` 칼럼이 `not null` 칼럼이지만 별도의 값이 지정되지 않았다.

- 두 번째 `insert` 쿼리는 `auto_increment` 속성으로 정의된 칼럼에 값을 강제로 할당했다.

  - 이런 경우 지정된 값으로 컬럼에 저장한다.

  - 만약 값을 할당하는데 `auto_increment`의 현재 값을 저장하고 싶다면 0 또는 null을 지정하면 된다.

여기서 두 번째와 같은 방법을 사용할 경우 `auto_increment`의 현재 값이 갱신된다.

- 지정한 값이 `auto_increment`의 현재 값보다 **작을 경우** `auto_increment`의 현재 값이 변하지 않는다.

- 지정한 값이 `auto_increment`의 현재 값보다 **클 경우** `auto_increment`의 값을 `지정한 값 + 1`로 설정한다.

> `auto_increment`의 칼럼에 0을 `insert` 하고 싶다면 `sql_mode` 시스템 변수에 `'NO_AUTO_VALUE_ON_ZERO'` 값을 추가하면 된다.
>
> ![image](https://user-images.githubusercontent.com/48052622/106356062-ffc32280-633f-11eb-9704-9682c54db581.png)
> 
> `sql_mode`에 `'NO_AUTO_VALUE_ON_ZERO'` 값을 추가하였다.
>
> ![image](https://user-images.githubusercontent.com/48052622/106356094-3b5dec80-6340-11eb-85d9-90eccbb146a5.png)
>
> `member_id`에 0 값이 저장됨을 확인할 수 있다.

`auto_increment` 칼럼을 사용할 경우 아래와 같은 규칙을 지키면서 사용해야 한다.

- `auto_increment` 속성을 가진 칼럼은 반드시 프라이머리 키나 유니크 키의 일부로 정의돼야 한다.

- `auto_increment` 속성을 가진 칼럼 하나로 프라이머리 키를 생성할 때는 아무런 제약이 없다.

- 여러 칼럼으로 프라이머리 키를 생성할 때

  - `auto_increment` 속성의 칼럼이 제일 앞일 때

    `auto_increment` 속성의 칼럼이 프라이머리 키의 제일 앞쪽에 위치하면 MyISAM이나 InnoDB 테이블에 아무런 제약이 없다.
  
  - `auto_increment` 속성의 칼럼이 제일 앞이 아닐 때
  
    MyISAM 테이블에서는 상관없지만 InnoDB 테이블에서는 이렇게 생성할 수 없다. InnoDB에서는 반드시 `unique index (fd2)`와 같이 fd2로 시작하는 unique 키를 하나 더 생성해야만 한다.
    
    ```sql
    
    ```
    
    MyISAM 테이블을 생성한 경우
    
    ![image](https://user-images.githubusercontent.com/48052622/106356449-030bdd80-6343-11eb-8d78-2c98ac72b3df.png)
    
    InnoDB 테이블을 생성한 경우 에러가 발생
    
    ![image](https://user-images.githubusercontent.com/48052622/106356466-22a30600-6343-11eb-8f5e-77aaa046d05c.png)
    
    InnoDB 테이블에 `unique index (fd2)`를 추가한 경우
    
    ![image](https://user-images.githubusercontent.com/48052622/106356502-58e08580-6343-11eb-9fa8-97b91f22056f.png)

`auto_increment` 컬럼과 다른 컬럼을 합쳐서 프라이머리 키를 생성하면 MyISAM과 InnoDB 테이블에서 각각 `auto_increment`가 증가하는 방식이 달라진다. MyISAM의 경우 `auto_increment` 칼럼을 프라이머리 키의 앞쪽에 정의하면 단순하게 증가하고 프라이머리 키의 뒤쪽에 `auto_increment` 칼럼을 사용하면 앞쪽 칼럼의 값에 의존해서 증가한다.

```sql
create table tb_myisam (
    fd1 char,
    fd2 int auto_increment,
    primary key (fd1, fd2)
)engine=MyISAM;

create table tb_innodb (
    fd1 char,
    fd2 int auto_increment,
    primary key (fd1, fd2),
    unique key (fd2)
)engine=INNODB;

insert into tb_innodb values ('a', null), ('a', null), ('b', null), ('b', null);
insert into tb_myisam values ('a', null), ('a', null), ('b', null), ('b', null);
```

InnoDB 테이블의 경우 `auto_increment` 칼럼이 단순하게 증가하였고

![image](https://user-images.githubusercontent.com/48052622/106356660-b75a3380-6344-11eb-9fa8-f449394678ab.png)

MyISAM 테이블의 경우 `auto_increment` 칼럼이 프라이머리 키의 뒤쪽에 정의될 경우 `auto_increment` 칼럼이 앞쪽 칼럼의 값에 의존해서 증가한다.

![image](https://user-images.githubusercontent.com/48052622/106356673-c80aa980-6344-11eb-983e-662da4631ae4.png)

MySQL 서버에는 `auto_increment_increment`와 `auto_increment_offset` 시스템 변수가 있다.
